name: CI APT Bootstrap

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare APT and install deps
        shell: bash
        run: |
          set -euo pipefail
          # Remove mirror+file drivers and rebuild sources.list
          sudo rm -f /etc/apt/apt-mirrors.txt || true
          sudo rm -f /etc/apt/sources.list.d/ubuntu.sources || true
          CODENAME=$( . /etc/os-release && echo "$UBUNTU_CODENAME" )
          cat <<EOF | sudo tee /etc/apt/sources.list > /dev/null
          deb http://archive.ubuntu.com/ubuntu $CODENAME main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu $CODENAME-updates main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu $CODENAME-security main restricted universe multiverse
          EOF
          sudo apt-get update -o Acquire::Retries=3
          retry() { for i in {1..3}; do "$@" && break || { echo "Retry $i/3 failed"; sleep 3; }; done; }
          retry sudo apt-get install -y --no-install-recommends --fix-missing \
            bison build-essential curl flex git gnat libncurses5-dev m4 nasm python-is-python3 uuid-dev zlib1g-dev
          echo "APT bootstrap completed successfully."
